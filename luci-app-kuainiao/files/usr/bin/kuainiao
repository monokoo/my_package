#!/bin/sh
#2017/05/01 by kenney
. /lib/functions.sh
#eval `dbus export kuainiao_`
#KSROOT="/jffs/koolshare"
#source $KSROOT/scripts/base.sh
LOGFILE=/var/log/kuainiao.log
version="0.4"
app_version="2.0.3.4"
protocolVersion=108
sdkVersion=17550

#WAN接口IP判断
get_bind_address(){
	ifname=$(uci -P /var/state get network.$kuainiao_config_wan.ifname 2>/dev/null)
	[ $? -eq 1 ] && echo $(date): "获取网络 $kuainiao_config_wan 信息出错" >>$LOGFILE && echo >>$LOGFILE && return
	echo $(date): ifname is $ifname >> $LOGFILE
	##wan_selected 所选接口IP
	wan_selected=$(ifconfig $ifname 2>/dev/null | grep 'inet addr' | awk '{print $2}' | cut -d: -f2 2>/dev/null)
	[ -z "$wan_selected" ] && echo $(date): "获取网络 $kuainiao_config_wan 接口 $ifname 信息出错" >>$LOGFILE && echo >>$LOGFILE && return
	if [ "$wan_selected" != "0.0.0.0" ]; then
		bind_address=$wan_selected
	else
		bind_address=""
	fi
}

#定义请求函数
#bind_address='113.248.3.11'
get_http_req(){
	if [ -n "$bind_address" ]; then
		HTTP_REQ="wget --bind-address=$bind_address --no-check-certificate -O - "
		POST_ARG="--post-data="
	else
		HTTP_REQ="wget --no-check-certificate -O - "
		POST_ARG="--post-data="
	fi
	kuainiao_HTTP_REQ=$HTTP_REQ
	kuainiao_POST_ARG=$POST_ARG
}

#数据mock

generate_pwd_rsa_hex()
{
	# calculate passwd_md5
	echo $(date): "Generating passwd md5" >> $LOGFILE
	passwd_md5=`echo -n "$kuainiao_config_pwd" | md5sum | tr -d " -"`

	if [ `echo -n "$passwd_md5" | wc -c` -ne 32 ]; then
		echo $(date): "md5sum should be 32 chars, exit." >> $LOGFILE
		exit 1
	fi

	echo $(date): "Generating PWD RSA HEX" >> $LOGFILE
    #first, encoding passwd using rsa
    a=`echo "$passwd_md5" | openssl rsautl -raw -pubin -inkey /etc/thunder.key  -hexdump | tr [a-z] [A-Z]`
    a=`echo $a | grep -o '00[0-9]0 \- \([A-Z0-9]\{2\}[- ]\)\{16\}' | sed 's/00[0-9]0 - //g' | tr -d " \-\n"`
    echo -n "$a"

}

#pwd='702CFAF5824E4306516F488DEAFC2D24F76C82FA53BA3396F5615FDD32E4430E45B254E136056ED5F3C5B404A08E2178B51330999A4EC3C2D2989D554D7863BDE8F058F44808E6B65F4D071B5D5C7210210DA9ED8D729312CECA39E0F4516143E33C089F616ABE93E14D3224BEB311D3D6EF65A6CE265D3E4ABA285523F14320'

get_device_sign(){
	ifname=$(uci get network.$kuainiao_config_wan.ifname 2>/dev/null)
	wan_mac=$(ifconfig $ifname | grep 'HWaddr' | awk '{print $5}')
	fake_device_id=$(echo -n "$wan_mac" | md5sum | cut -d ' ' -f1)
	fake_device_id_tmp1=$(echo -n "$fake_device_id"com.xunlei.vip.swjsq68700d1872b772946a6940e4b51827e8af"" | openssl sha1 -hmac | awk '{print $2}')
	devicesign="div100."${fake_device_id}$(echo -n "$fake_device_id_tmp1" | md5sum | cut -d ' ' -f1)
}


#verifyCode=$kuainiao_config_verifyCode
#verifyKey=$kuainiao_verifyKey

#获取用户真实MAC地址
get_mac_addr(){
	if [ -n "$bind_address" ]; then
		ifname=$(uci get network.$kuainiao_config_wan.ifname 2>/dev/null)
		peerid=$(ifconfig $ifname | grep 'HWaddr' | awk '{print $5}' | awk 'gsub(/:/, "")')004V
	fi
	#peerid='000C29212478004V'
}

#nic=eth0
#peerid=$(ifconfig $nic|grep $nic|awk 'gsub(/:/, "") {print $5}')004V


#获取迅雷用户uid
get_xunlei_uid(){
	get_http_req
	echo $(date): HTTP_REQ is $HTTP_REQ >> $LOGFILE
	echo $(date): POST_ARG is $POST_ARG >> $LOGFILE
	uname=$kuainiao_config_uname
	#get_mac_addr
	echo $(date): peerid is $peerid >> $LOGFILE
	[ -z "$peerid" ] && exit 0
	#pwd=$generate_pwd_rsa_hex
	pwd=$kuainiao_config_pwd
	get_device_sign
	echo $(date): devicesign is $devicesign >> $LOGFILE
	ret=`$HTTP_REQ --header "User-Agent:android-async-http/xl-acc-sdk/version-1.6.1.177600" https://login.mobile.reg2t.sandai.net:443/ $POST_ARG"{\"userName\":\""$uname"\",\"businessType\":68,\"clientVersion\":\"$app_version\",\"appName\":\"ANDROID-com.xunlei.vip.swjsq\",\"isCompressed\":0,\"sequenceNo\":1000001,\"sessionID\":\"\",\"loginType\":0,\"rsaKey\":{\"e\":\"010001\",\"n\":\"AC69F5CCC8BDE47CD3D371603748378C9CFAD2938A6B021E0E191013975AD683F5CBF9ADE8BD7D46B4D2EC2D78AF146F1DD2D50DC51446BB8880B8CE88D476694DFC60594393BEEFAA16F5DBCEBE22F89D640F5336E42F587DC4AFEDEFEAC36CF007009CCCE5C1ACB4FF06FBA69802A8085C2C54BADD0597FC83E6870F1E36FD\"},\"cmdID\":1,\"verifyCode\":\"$verifyCode\",\"peerID\":\""$peerid"\",\"protocolVersion\":$protocolVersion,\"platformVersion\":1,\"passWord\":\""$pwd"\",\"extensionList\":\"\",\"verifyKey\":\"$verifyKey\",\"sdkVersion\":$sdkVersion,\"devicesign\":\""$devicesign"\"}"`
	#判断是否登陆成功
	#echo $ret >>test.txt
	echo $(date): "........................" >> $LOGFILE
	echo $(date): ret is $ret >> $LOGFILE
	echo $(date): "........................" >> $LOGFILE
	session=`echo $ret|awk -F '"sessionID":' '{print $2}'|awk -F '[,}]' '{print $1}'|grep -oE "[A-F,0-9]{32}"`
	echo $(date): session is $session >> $LOGFILE
	#vcode=`echo $ret|awk -F '"errorDescUrl":' '{print $2}'|awk -F '}' '{print $1}'`
	#vcode=`echo $vcode|sed 's/\\//g'`
	errcode=`echo $ret|awk -F '"errorCode":' '{print $2}'|awk -F '[,}]' '{print $1}'`
	echo $(date): errcode is $errcode >> $LOGFILE
	if [ -z "$session" ]; then
	  	  if [ $errcode == 6 ];then
			#dbus set kuainiao_vcodeimg_url="$vcode"
			#dbus set kuainiao_verifyKey='F9F6FBE928911784D809EBF046ABE0A6A467583F3944507099EA54BC9B5DA7BD'
			kuainiao_last_act="<font color=red>您的账号不安全，需要输入验证码! $(date "+%Y-%m-%d %H:%M:%S")</font>"
			
		  elif [ $errcode == 12 ];then
		  	#dbus set kuainiao_vcodeimg_url=""
			#dbus set kuainiao_verifyKey=''
		  	kuainiao_last_act="<font color=red>登陆协议无效，请更新！$(date "+%Y-%m-%d %H:%M:%S")</font>"
			  
		  elif [ $errcode == 3 ];then
		  	#dbus set kuainiao_vcodeimg_url=""
			#dbus set kuainiao_verifyKey=''
		  	kuainiao_last_act="<font color=red>用户名密码错误，请检查！$(date "+%Y-%m-%d %H:%M:%S")</font>"
			  
		  else
		  	#dbus set kuainiao_vcodeimg_url=""
			#dbus set kuainiao_verifyKey=''
		  	uainiao_last_act="<font color=red>迅雷账号登陆失败，请检查输入的用户名密码! $(date "+%Y-%m-%d %H:%M:%S")</font>"
			 
		  fi
		  #echo "迅雷账号登陆失败，请检查输入的用户名密码!"
		 
	  else
		  uid=`echo $ret|awk -F '"userID":' '{print $2}'|awk -F '[,}]' '{print $1}'`
		  kuainiao_config_uid=$uid
		  kuainiao_config_session=$session
		  kuainiao_last_act="<font color=green>迅雷快鸟已登陆成功!</font>"
	fi
	echo "$kuainiao_last_act" > /usr/share/kuainiao/kuainiao_down_state
	echo $(date): "$kuainiao_last_act" >> $LOGFILE
}

#获取加速API
get_kuainiao_api(){
	portal=`$HTTP_REQ http://api.portal.swjsq.vip.xunlei.com:81/v2/queryportal`
	portal_ip=`echo $portal|grep -oE '([0-9]{1,3}[\.]){3}[0-9]{1,3}'`
	portal_port_temp=`echo $portal|grep -oE "port...[0-9]{1,5}"`
	portal_port=`echo $portal_port_temp|grep -oE '[0-9]{1,5}'`
	echo $(date): "portal is $portal" >> $LOGFILE
	echo $(date): "portal_ip is $portal_ip" >> $LOGFILE
	echo $(date): "portal_port_temp is $portal_port_temp" >> $LOGFILE
	echo $(date): "portal_port is $portal_port" >> $LOGFILE
	if [ -z "$portal_ip" ]; then
			kuainiao_down_state="迅雷快鸟下行API获取失败，请检查网络环境，或稍后再试!"
			echo $(date): "$kuainiao_down_state" >> $LOGFILE
		else
			api_url="http://$portal_ip:$portal_port/v2"
			kuainiao_config_api=$api_url
	fi
}

#获取上行加速API
get_kuainiao_upapi(){
	upportal=`$HTTP_REQ http://api.upportal.swjsq.vip.xunlei.com/v2/queryportal`
	upportal_ip=`echo $upportal|grep -oE '([0-9]{1,3}[\.]){3}[0-9]{1,3}'`
	upportal_port_temp=`echo $upportal|grep -oE "port...[0-9]{1,5}"`
	upportal_port=`echo $upportal_port_temp|grep -oE '[0-9]{1,5}'`
	if [ -z "$upportal_ip" ]; then
			kuainiao_up_state="迅雷快鸟上行API获取失败，请检查网络环境，或稍后再试!"
			#echo "迅雷快鸟服务API获取失败，请检查网络环境，或稍后再试!"
			echo $(date): "$kuainiao_up_state" >> $LOGFILE
		else
			upapi_url="http://$upportal_ip:$upportal_port/v2"
			kuainiao_config_upapi=$upapi_url
	fi
}


#检测快鸟加速信息
get_bandwidth(){
	echo $(date): api_url is $api_url >> $LOGFILE
	echo $(date): peerid is $peerid >> $LOGFILE
	if [ -n "$api_url" ]; then
		echo $(date): HTTP_REQ is $HTTP_REQ >> $LOGFILE
		echo $(date): POST_ARG is $POST_ARG >> $LOGFILE
		bandwidth
		echo $(date): width is $width >> $LOGFILE
		band=$width
		echo $(date): band is $band >> $LOGFILE
		can_upgrade=`echo $band|awk -F '"can_upgrade":' '{print $2}'|awk -F '[,}]' '{print $1}'`
		echo $(date): can_upgrade is $can_upgrade >> $LOGFILE
		kuainiao_can_upgrade=$can_upgrade
		echo $(date): kuainiao_can_upgrade is $kuainiao_can_upgrade >> $LOGFILE
		dial_account=`echo $band|awk -F '"dial_account":"' '{print $2}'|awk -F '[,}"]' '{print $1}'`
		kuainiao_dial_account=$dial_account
		echo $(date): dial_account is $dial_account >> $LOGFILE
		echo $(date): kuainiao_dial_account is $kuainiao_dial_account >> $LOGFILE
		#判断是否满足加速条件
		if [ "$can_upgrade" -eq 1 ]; then
			#echo "迅雷快鸟可以加速~~~愉快的开始加速吧~~"
			#获取加速详细信息
			old_downstream=`echo $band|awk -F '"bandwidth":' '{print $2}'|awk -F '"downstream":' '{print $2}'|awk -F '[,}]' '{print $1}'`
			max_downstream=`echo $band|awk -F '"max_bandwidth":' '{print $2}'|awk -F '"downstream":' '{print $2}'|awk -F '[,}]' '{print $1}'`
			echo $(date): dial_account is $old_downstream >> $LOGFILE
			echo $(date): dial_account is $max_downstream >> $LOGFILE
			down_state="下行可以加速"
			kuainiao_old_downstream=$(expr $old_downstream / 1024)
			kuainiao_max_downstream=$(expr $max_downstream / 1024)
			echo $(date): kuainiao_old_downstream is $kuainiao_old_downstream >> $LOGFILE
			echo $(date): kuainiao_max_downstream is $kuainiao_max_downstream >> $LOGFILE
		else
			down_state="下行不满足加速条件"
			#echo "T_T 不能加速啊，不满足加速条件哦~~"
		fi
		echo $(date): "$down_state" >> $LOGFILE
		kuainiao_down_state=$down_state
		
	fi
}

#检测快鸟上行加速信息
get_upbandwidth(){
	echo $(date): upapi_url is $upapi_url >> $LOGFILE
	if [ -n "$upapi_url" ]; then
		band=$upbandwidth
		echo $(date): upbandwidth is $band >> $LOGFILE
		can_upgrade=`echo $band|awk -F '"can_upgrade":' '{print $2}'|awk -F '[,}]' '{print $1}'`
		kuainiao_can_upupgrade=$can_upgrade
		updial_account=`echo $band|awk -F '"dial_account":"' '{print $2}'|awk -F '[,}"]' '{print $1}'`
		kuainiao_dial_upaccount=$updial_account
		echo $(date): can_upgrade is $can_upgrade >> $LOGFILE
		echo $(date): kuainiao_can_upupgrade is $kuainiao_can_upupgrade >> $LOGFILE
		echo $(date): updial_account is $updial_account >> $LOGFILE
		echo $(date): kuainiao_dial_upaccount is $kuainiao_dial_upaccount >> $LOGFILE
		#判断是否满足加速条件
		if [ "$can_upgrade" -eq 1 ]; then
			#echo "迅雷快鸟可以加速~~~愉快的开始加速吧~~"
			#获取加速详细信息
			old_upstream=`echo $band|awk -F '"bandwidth":' '{print $2}'|awk -F '"upstream":' '{print $2}'|awk -F '[,}]' '{print $1}'`
			max_upstream=`echo $band|awk -F '"max_bandwidth":' '{print $2}'|awk -F '"upstream":' '{print $2}'|awk -F '[,}]' '{print $1}'`
			echo $(date): old_upstream is $old_upstream >> $LOGFILE
			echo $(date): max_upstream is $max_upstream >> $LOGFILE
			up_state="上行可以加速"
			kuainiao_old_upstream=$(expr $old_upstream / 1024)
			kuainiao_max_upstream=$(expr $max_upstream / 1024)
			echo $(date): kuainiao_old_upstream is $kuainiao_old_upstream >> $LOGFILE
			echo $(date): kuainiao_max_upstream is $kuainiao_max_upstream >> $LOGFILE
		else
			up_state="上行不满足加速条件"
			#echo "T_T 不能加速啊，不满足加速条件哦~~"
		fi
		echo $(date): "$up_state" >> $LOGFILE
		kuainiao_up_state=$up_state
		
	fi
}


#检测试用加速信息
query_try_info(){
	info=`$HTTP_REQ "$api_url/query_try_info?peerid=$peerid&userid=$uid&user_type=1&sessionid=$session"`
	echo $info
}
##{"errno":0,"message":"","number_of_try":0,"richmessage":"","sequence":0,"timestamp":1455936922,"try_duration":10}

query_try_upinfo(){
	info=`$HTTP_REQ "$upapi_url/query_try_info?peerid=$peerid&userid=$uid&client_type=android-uplink-2.3.3.9&client_version=andrioduplink-2.3.3.9&os=android-7.0.24DUK-AL20&sessionid=$session"`
	echo $info
}
##{"errno":0,"exp_day_len":0,"is_exp_day":0,"message":"","number_of_try":1,"richmessage":"","sequence":268435461,"timestamp":1493469390,"try_duration":10}

get_upgrade_down(){
	_ts=`date +%s`000
	ret=`$HTTP_REQ "$api_url/upgrade?peerid=$peerid&userid=$uid&user_type=1&sessionid=$kuainiao_config_session&dial_account=$dial_account&client_type=android-swjsq-$app_version&client_version=androidswjsq-$app_version&os=android-5.0.1.24SmallRice&time_and=$_ts"`
	errcode=`echo $ret|awk -F '"errno":' '{print $2}'|awk -F '[,}"]' '{print $1}'`
	if [ "$errcode" == "0" ]; then
		down_state="$down_state （您的下行带宽已从$kuainiao_old_downstream M提升到$kuainiao_max_downstream M）"
	else
		down_state="$down_state 下行带宽提升失败，请检查宽带账号是否绑定正确"
	fi
	echo $(date): "$down_state" >> $LOGFILE
	kuainiao_down_state=$down_state
}

get_upgrade_up(){
	_ts=`date +%s`000
	up_ret=`$HTTP_REQ  --header "User-Agent:android-async-http/xl-acc-sdk/version-1.0.0.1" "$upapi_url/upgrade?peerid=$peerid&userid=$uid&client_type=android-uplink-2.3.3.9&client_version=andrioduplink-2.3.3.9&os=android-7.0.24DUK-AL20&sessionid=$session&user_type=1&dial_account=$updial_account"`
	errcode=`echo $up_ret|awk -F '"errno":' '{print $2}'|awk -F '[,}"]' '{print $1}'`
	if [ "$errcode" == "0" ] || [ "$errcode" == "812" ];then
		up_state="$up_state （您的上行带宽已从$kuainiao_old_upstream M提升到$kuainiao_max_upstream M）"
	else
		up_state="$up_state 上行带宽提升失败，请检查宽带账号是否绑定正确"
	fi
	echo $(date): "$up_state" >> $LOGFILE
	kuainiao_up_state=$up_state
}

keepalive_up(){
	_ts=`date +%s`000
	up_ret=`$HTTP_REQ  --header "User-Agent:android-async-http/xl-acc-sdk/version-1.0.0.1" "$upapi_url/keepalive?peerid=$peerid&userid=$uid&client_type=android-uplink-2.3.3.9&client_version=andrioduplink-2.3.3.9&os=android-7.0.24DUK-AL20&sessionid=$session&user_type=1&dial_account=$kuainiao_dial_upaccount"`
	errcode=`echo $up_ret|awk -F '"errno":' '{print $2}'|awk -F '[,}"]' '{print $1}'`
	if [ "$errcode" != "0" ];then
		#dbus set kuainiao_run_upid=0
		#dbus set kuainiao_up_state="迅雷上行提速失效！$(date '+%Y-%m-%d %H:%M:%S')"
		kuainiao_run_upstatus=0
	else
		#dbus set kuainiao_run_upid=$(expr $kuainiao_run_upid + 1)
		kuainiao_up_state="您的上行带宽已从${kuainiao_old_upstream}M提升到${kuainiao_max_upstream}M  $(date '+%Y-%m-%d %H:%M:%S')"
		kuainiao_run_upstatus=1
	fi
}


#检测提速带宽
bandwidth(){
	echo $(date): "bandwidth start" >> $LOGFILE
	echo $(date): "peerid is $peerid" >> $LOGFILE
	echo $(date): "uid is $uid" >> $LOGFILE
	echo $(date): "session is $session" >> $LOGFILE
	_ts=`date +%s`000
	echo $(date): "_ts is $_ts" >> $LOGFILE
	width=`$HTTP_REQ "$api_url/bandwidth?peerid=$peerid&userid=$uid&user_type=1&sessionid=$session&dial_account=$dial_account&client_type=android-swjsq-$app_version&client_version=androidswjsq-$app_version&os=android-5.0.1.24SmallRice&time_and=$_ts"`
	#echo $width
}
##{"bandwidth":{"downstream":51200,"upstream":0},"can_upgrade":1,"dial_account":"100001318645","errno":0,"max_bandwidth":{"downstream":102400,"upstream":0},"message":"","province":"bei_jing","province_name":"北京","richmessage":"","sequence":0,"sp":"cnc","sp_name":"联通","timestamp":1455936922}

upbandwidth(){
	_ts=`date +%s`000
	width=`$HTTP_REQ "$upapi_url/bandwidth?peerid=$peerid&userid=$uid&user_type=1&sessionid=$session&dial_account=$dial_account&client_type=android-swjsq-$app_version&client_version=androidswjsq-$app_version&os=android-5.0.1.24SmallRice&time_and=$_ts"`
	echo $width
}


#迅雷快鸟加速心跳
keepalive_down(){
	_ts=`date +%s`000
	ret=`$HTTP_REQ "$api_url/keepalive?peerid=$peerid&userid=$uid&user_type=1&sessionid=$session&dial_account=$dial_account&client_type=android-swjsq-$app_version&client_version=androidswjsq-$app_version&os=android-5.0.1.24SmallRice&time_and=$_ts"`
	errcode=`echo $ret|awk -F '"errno":' '{print $2}'|awk -F '[,}"]' '{print $1}'`
	if [ "$errcode" != "0" ];then
		#dbus set kuainiao_run_upid=0
		#dbus set kuainiao_down_state="迅雷下行提速失效！"$(date "+%Y-%m-%d %H:%M:%S")
		kuainiao_run_status=0
	else
		#dbus set kuainiao_run_upid=$(expr $kuainiao_run_upid + 1)
		kuainiao_down_state="您的下行带宽已从${kuainiao_old_downstream}M提升到${kuainiao_max_downstream}M $(date '+%Y-%m-%d %H:%M:%S')"
		kuainiao_run_status=1
		echo $(date): "$kuainiao_down_state" >> $LOGFILE
	fi
}

#快鸟加速注销
kuainiao_recover(){
	_ts=`date +%s`000
	recover=`$HTTP_REQ "$api_url/recover?peerid=$peerid&userid=$uid&user_type=1&sessionid=$session&dial_account=$dial_account&client_type=android-swjsq-$app_version&client_version=androidswjsq-$app_version&os=android-5.0.1.24SmallRice&time_and=$_ts"`
	echo $recover
}

kuainiao_uprecover(){
	_ts=`date +%s`000
	recover=`$HTTP_REQ "$upapi_url/recover?peerid=$peerid&userid=$uid&client_type=android-uplink-2.3.3.9&client_version=andrioduplink-2.3.3.9&os=android-7.0.24DUK-AL20&sessionid=$session&user_type=1&dial_account=$updial_account"`
	echo $recover
}


#将执行脚本写入crontab定时运行
add_kuainiao_cru(){
	cru d kuainiao
	if [ "$kuainiao_can_upgrade" == "1" ]||[ "$kuainiao_can_upupgrade" == "1" ];then
		cru a kuainiao "*/4 * * * * /bin/sh $KSROOT/scripts/kuainiao_keep.sh"
	fi
}

#加入开机自动运行
auto_start(){
	if [ -L "$KSROOT/init.d/S95Kuainiao.sh" ]; then 
		rm -rf $KSROOT/init.d/S95Kuainiao.sh
	fi
	if [ -L "$KSROOT/init.d/S99Kuainiao.sh" ]; then 
		rm -rf $KSROOT/init.d/S99Kuainiao.sh
	fi
	if [ "$kuainiao_start" == "1" ]; then
		ln -sf $KSROOT/scripts/kuainiao_keep.sh $KSROOT/init.d/S99Kuainiao.sh
	fi
}

#停止快鸟服务
stop_kuainiao(){
	#停掉cru里的任务
	cru d kuainiao
	#停止自启动
	if [ -L "$KSROOT/init.d/S95Kuainiao.sh" ]; then 
		rm -rf $KSROOT/init.d/S95Kuainiao.sh
	fi
	#清理运行环境临时变量
	# dbus remove kuainiao_run_id
	# dbus remove kuainiao_run_upid
	# dbus remove kuainiao_run_status
	# dbus remove kuainiao_run_upstatus
	# dbus remove kuainiao_config_session
	# dbus remove kuainiao_can_upgrade
	# dbus remove kuainiao_can_upupgrade
	# dbus remove kuainiao_down_state
	# dbus remove kuainiao_up_state
	kuainiao_last_act="<font color=red>服务未开启</font>"
}

##主逻辑
#执行初始化
kuainiao_init(){
	local kuainiao_last_act=""
	local kuainiao_can_upgrade=0
	local kuainiao_can_upupgrade=0
	local kuainiao_down_state=""
	local kuainiao_up_state=""
}


#start(){
	kuainiao_init
	config_load kuainiao
	config_get_bool enabled base enabled 0
	config_get_bool kuainiao_downenable base enable_down 0
	config_get_bool kuainiao_upenable base enable_up 0
	config_get kuainiao_config_wan base speed_wan
	config_get kuainiao_config_uname base kuainiao_name
	config_get kuainiao_config_pwd base kuainiao_config_pwd
	
	echo $(date): enabled is $enabled >> $LOGFILE
	echo $(date): kuainiao_downenable is $kuainiao_downenable >> $LOGFILE
	echo $(date): kuainiao_upenable is $kuainiao_upenable >> $LOGFILE
	echo $(date): kuainiao_config_wan is $kuainiao_config_wan >> $LOGFILE
	echo $(date): kuainiao_config_uname is $kuainiao_config_uname >> $LOGFILE
	echo $(date): kuainiao_config_pwd is $kuainiao_config_pwd >> $LOGFILE
		
	if [ "$kuainiao_downenable" -eq 1 ] || [ "$kuainiao_upenable" -eq 1 ]; then
		#sleep $kuainiao_time  启动延时
		echo $(date): sleep time now启动延时 >> $LOGFILE
		sleep 10s
		
		#登陆迅雷获取uid
		echo $(date): get_bind_address start >> $LOGFILE
		get_bind_address
		echo $(date): bind_address is $bind_address >> $LOGFILE 
		echo $(date): get_mac_addr start >> $LOGFILE
		get_mac_addr
		echo $(date): peerid is $peerid >> $LOGFILE
		echo $(date): get_xunlei_uid start >> $LOGFILE
		get_xunlei_uid
		echo $(date): get_xunlei_uid is done >> $LOGFILE
		echo $(date): uid is $uid  >> $LOGFILE
		#判断是否登陆成功
		if [ -n "$uid" ]; then
			if [ "$kuainiao_downenable" -eq 1 ]; then
				echo $(date): get_kuainiao_api start >> $LOGFILE
				get_kuainiao_api
				echo $(date): get_bandwidth start >> $LOGFILE
				get_bandwidth
				kuainiao_config_downstream=$(expr $old_downstream / 1024)
				kuainiao_config_max_downstream=$(expr $max_downstream / 1024)
				echo $(date): kuainiao_config_downstream is $kuainiao_config_downstream >> $LOGFILE
				echo $(date): kuainiao_config_max_downstream is $kuainiao_config_max_downstream >> $LOGFILE
				echo $(date): kuainiao_can_upgrade is $kuainiao_can_upgrade >> $LOGFILE
				if [ "$kuainiao_can_upgrade" -eq 1 ]; then
					echo $(date): get_upgrade_down start >> $LOGFILE
					get_upgrade_down
					echo $(date): get_upgrade_down is done >> $LOGFILE
					sleep 1
					#keepalive_down
				fi
			fi
			if [ "$kuainiao_upenable" -eq 1 ]; then
				echo $(date): get_kuainiao_upapi start >> $LOGFILE
				get_kuainiao_upapi
				echo $(date): get_upbandwidth start >> $LOGFILE
				get_upbandwidth
				kuainiao_config_upstream=$(expr $old_upstream / 1024)
				kuainiao_config_max_upstream=$(expr $max_upstream / 1024)
				echo $(date): kuainiao_config_upstream is $kuainiao_config_upstream >> $LOGFILE
				echo $(date): kuainiao_config_max_upstream is $kuainiao_config_max_upstream >> $LOGFILE
				echo $(date): kuainiao_can_upupgrade is $kuainiao_can_upupgrade >> $LOGFILE
				if [ "$kuainiao_can_upupgrade" -eq 1 ]; then
					echo $(date): get_upgrade_up start >> $LOGFILE
					get_upgrade_up
					sleep 1
					#keepalive_up 
				fi
			fi
		fi
		#add_kuainiao_cru
	fi
#}

stop(){
	stop_kuainiao
}
# *)
	# kuainiao_init
	# if [ "$kuainiao_downenable" == "1" ] || [ "$kuainiao_upenable" == "1" ]; then
	# sleep $kuainiao_time
	# #登陆迅雷获取uid
	# get_xunlei_uid
	# #判断是否登陆成功
	# if [ -n "$uid" ]; then
	  # if [ "$kuainiao_downenable" == "1" ];then
		# get_kuainiao_api
		# get_bandwidth
		# dbus set kuainiao_config_downstream=$(expr $old_downstream / 1024)
		# dbus set kuainiao_config_max_downstream=$(expr $max_downstream / 1024)
		# if [ "$kuainiao_can_upgrade" == "1" ];then
			# get_upgrade_down
			# sleep 1
			# keepalive_down
		# fi
	  # fi
	  # if [ "$kuainiao_upenable" == "1" ];then
	  	# get_kuainiao_upapi
		# get_upbandwidth
		# dbus set kuainiao_config_upstream=$(expr $old_upstream / 1024)
		# dbus set kuainiao_config_max_upstream=$(expr $max_upstream / 1024)
		# if [ $kuainiao_can_upupgrade == 1 ];then
			# get_upgrade_up
			# sleep 1
			# keepalive_up
		# fi
	  # fi
	# fi
	# add_kuainiao_cru
	# auto_start
	# else
		# stop_kuainiao
	# fi
	# ;;
# esac
# http_response '设置已保存！切勿重复提交！页面将在3秒后刷新'